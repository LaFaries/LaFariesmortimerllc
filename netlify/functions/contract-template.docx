const PizZip = require("pizzip");
const Docxtemplater = require("docxtemplater");
const fs = require("fs");
const path = require("path");

exports.handler = async (event) => {
  // Only allow POST requests
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      body: "Method Not Allowed",
    };
  }

  try {
    // 1️⃣ Parse incoming form data
    const data = JSON.parse(event.body);

    // 2️⃣ Load the Word template from the SAME folder
    const templatePath = path.resolve(
      __dirname,
      "contract-template.docx"
    );

    const content = fs.readFileSync(templatePath, "binary");

    // 3️⃣ Unzip the DOCX
    const zip = new PizZip(content);

    // 4️⃣ Initialize Docxtemplater
    const doc = new Docxtemplater(zip, {
      paragraphLoop: true,
      linebreaks: true,
    });

    // 5️⃣ Inject form values into the document
    doc.render({
      client_name: data.client_name,
      service_fee: data.service_fee,
      current_date: new Date().toLocaleDateString(),
    });

    // 6️⃣ Generate the finished file
    const buffer = doc.getZip().generate({
      type: "nodebuffer",
      compression: "DEFLATE",
    });

    // 7️⃣ Return the file to the browser
    return {
      statusCode: 200,
      headers: {
        "Content-Disposition": `attachment; filename="Contract-${data.client_name}.docx"`,
        "Content-Type":
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      },
      body: buffer.toString("base64"),
      isBase64Encoded: true,
    };
  } catch (error) {
    console.error("Contract generation failed:", error);

    return {
      statusCode: 500,
      body: "Error generating contract",
    };
  }
};

